---
marp: true
theme: default
paginate: true
---

# HaskellによるOS開発の実現可能性

技術的に可能か？適しているか？

---

# 結論

**技術的に可能であり、特定の目的には非常に適している**

- 既存のHaskell製OSで実証済み
- 特定のメリットがある

---

# 既存事例: House

## Haskellで書かれたデモOS

- 基盤: hOp（GHC RTSベースのマイクロカーネル）
- ページフォルトハンドラ（Haskell）
- システムコールハンドラ（Haskell）

---

# House: 実装済み機能

- NE2000互換ネットワークカードドライバ
- Intel PRO/100ネットワークカードドライバ
- ネットワークプロトコルスタック
  - Ethernet, IPv4, ARP, DHCP
  - ICMP (ping), UDP, TFTP, TCP

**高レベル関数型言語で低レベルシステムプログラミングが可能**

---

# 既存事例: HaLVM

## Haskell Lightweight Virtual Machine

- 開発: Galois社（2006年〜）
- Xen上で直接動作
- カーネル/ユーザーランドの境界なし

---

# HaLVMの特徴

- 通常のHaskellコードがそのまま動作
- 多くの純粋Haskellライブラリが移植可能
- OSコンポーネントの迅速なプロトタイピング

---

# 推奨アーキテクチャ

```
┌─────────────────────────────────────┐
│          Haskell Layer              │
│  ・デバイスドライバ                 │
│  ・ファイルシステム                 │
│  ・ネットワークスタック             │
│  ・プロセス管理ロジック             │
├─────────────────────────────────────┤
│     Thin C/Assembly Microkernel     │
│  ・ブートローダ                     │
│  ・割り込みベクタ設定               │
│  ・GHC RTS初期化                    │
└─────────────────────────────────────┘
```

---

# 低レベルアクセスの実現手段

| 手段 | 用途 |
|------|------|
| FFI | C関数呼び出し、ハードウェアアクセス |
| Foreign.Storable | メモリ操作（peek, poke） |
| alloca | 手動メモリ管理 |
| Ptr型 | ポインタ操作 |

---

# メリット一覧

| 観点 | 利点 |
|------|------|
| 型安全性 | コンパイル時にバグを検出 |
| 形式検証 | 純粋関数は数学的証明が容易 |
| 並行処理 | 競合状態が起きにくい |
| 抽象化 | 高レベルな記述で複雑さを管理 |
| テスタビリティ | 純粋関数は単体テストが容易 |

---

# 課題1: ガベージコレクション

## 最大の技術的障壁

- 現行GHCのGCは非並行・非インクリメンタル
- GC中は「世界停止」が発生
- リアルタイム性が求められるカーネルで問題

---

# GCの対策案

| 対策 | 詳細 |
|------|------|
| リアルタイムGC | インクリメンタルGCへの置き換え |
| マニュアル管理 | 特定領域でFFI経由の明示的管理 |
| リージョンベース | スコープベースの自動解放 |
| Linear Types | 線形型でGCを回避 |

---

# 課題2: デバッグ

## 問題
- 低レベルデバッグツールの不足

## 対策
- ログベースのデバッグ
- QEMUなどのエミュレータでのテスト
- 純粋関数部分の単体テスト重視

---

# 課題3: ライブラリ互換性

## 問題
- 多くのHaskellライブラリがPOSIX依存

## 対策
- 純粋Haskellライブラリの選択
- 必要なライブラリの移植
- 独自実装

---

# 課題4: パフォーマンス

## 問題
- CPU/メモリ効率がCに劣る場合がある

## 対策
- 適切な最適化（インライン展開、融合変換）
- クリティカルパスのプロファイリング
- 必要に応じてFFIでC実装を呼び出し

---

# 総合評価

| 評価軸 | 判定 |
|--------|------|
| 表現力 | ✅ IOモナド、FFIで十分対応可能 |
| 実現可能性 | ✅ House, HaLVMで実証済み |
| 研究・教育目的 | ✅ 非常に適している |
| 商用リアルタイムOS | ⚠️ GCとパフォーマンスに要対策 |

---

# LOSへの示唆

1. **段階的に構築**: 最小限のマイクロカーネルから開始
2. **純粋性を重視**: できる限り純粋関数で記述
3. **効果を明示**: IOモナドやAlgebraic Effectsで副作用を制御
4. **線形型を活用**: リソース管理の安全性確保
